{% extends "minimal.html" %}

{% block title %}å¬å†™å¡ç‰‡{% endblock %}

{% block page_styles %}
{{ super() }}
<style>
    /* å¬å†™æ¨¡å¼ç‰¹æœ‰æ ·å¼ */
    .container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 120px); /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™å‡ºæ›´å¤šç©ºé—´ */
        padding-bottom: 80px; /* ç¡®ä¿å¡ç‰‡ä¸ä¼šè¢«åº•éƒ¨æŒ‰é’®é®æŒ¡ */
    }
    .flashcard-grid {
        display: block; /* è¦†ç›– minimal.html çš„å¸ƒå±€ */
        width: 100%;
        max-width: 400px; /* é™åˆ¶å¡ç‰‡æœ€å¤§å®½åº¦ */
    }
    .card {
        margin: 0 auto; /* å±…ä¸­æ˜¾ç¤º */
        display: none; /* é»˜è®¤éšè—æ‰€æœ‰å¡ç‰‡ */
        width: 100%; /* ä½¿ç”¨å®¹å™¨çš„å…¨å®½ */
        max-width: 74.25mm; /* ä¿æŒæ ‡å‡†å¡ç‰‡å°ºå¯¸ */
    }
    .card.active {
        display: block; /* åªæ˜¾ç¤ºå½“å‰æ¿€æ´»çš„å¡ç‰‡ */
    }
    
    /* æ§åˆ¶æŒ‰é’®åŒºåŸŸ - ä½äºå¡ç‰‡å¤–éƒ¨ */
    .listen-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 24px;
        border-radius: 30px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .listen-controls button {
        padding: 10px 18px;
        font-size: 0.9em;
        font-weight: 500;
        border: none;
        border-radius: 22px;
        cursor: pointer;
        background: linear-gradient(135deg, var(--primary-color), #2980b9);
        color: white;
        transition: all 0.3s ease;
        min-width: 90px;
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }
    
    .listen-controls button:hover {
        background: linear-gradient(135deg, #2980b9, #1f5f8b);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
    
    .listen-controls button:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
    }
    
    /* å¬å†™çŠ¶æ€æŒ‡ç¤º */
    .listen-status {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 1em;
        font-weight: 500;
        display: none;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* éšè—å¡ç‰‡å†…å®¹çš„çŠ¶æ€ */
    .card.listening .card-content {
        opacity: 0.2;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    
    .card.listening .listen-status {
        display: block;
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
</style>
{% endblock %}

{% block body_content %}
{{ super() }}
<!-- å¬å†™æ§åˆ¶æŒ‰é’® -->
<div class="listen-controls">
    <button id="play-button">ğŸ”Š æ’­æ”¾</button>
    <button id="reveal-button">ğŸ‘ï¸ æ˜¾ç¤ºç­”æ¡ˆ</button>
    <button id="next-button">â¡ï¸ ä¸‹ä¸€å¼ </button>
</div>

<!-- å¬å†™çŠ¶æ€æŒ‡ç¤º */
<div class="listen-status" id="listen-status">
    æ­£åœ¨æ’­æ”¾...
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // å¬å†™åŠŸèƒ½è„šæœ¬
    const playButton = document.getElementById('play-button');
    const revealButton = document.getElementById('reveal-button');
    const nextButton = document.getElementById('next-button');
    const listenStatus = document.getElementById('listen-status');
    const cardGrid = document.getElementById('cardGrid');
    const cards = Array.from(document.querySelectorAll('.card'));

    let isRevealed = false;
    let currentCardIndex = 0;

    function showOnlyIndex(index) {
        const total = cards.length;
        currentCardIndex = ((index % total) + total) % total; // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
        cards.forEach((card, i) => {
            if (i === currentCardIndex) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
        });
        // æ¯æ¬¡åˆ‡æ¢å¡ç‰‡æ—¶ï¼Œé‡ç½®ç¿»è½¬çŠ¶æ€å’Œæ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®æ–‡æœ¬
        isRevealed = false;
        revealButton.textContent = 'ğŸ‘ï¸ æ˜¾ç¤ºç­”æ¡ˆ';
        // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³æ’­æ”¾
        speechSynthesis.cancel();
        // ç§»é™¤listeningçŠ¶æ€
        const currentCard = getCurrentCard();
        if (currentCard) {
            currentCard.classList.remove('listening', 'flipped');
        }
    }

    // è·å–å½“å‰æ˜¾ç¤ºçš„å¡ç‰‡
    function getCurrentCard() {
        return cards[currentCardIndex];
    }

    // è·å–å½“å‰å¡ç‰‡çš„å†…å®¹
    function getCurrentCardContent() {
        const currentCard = getCurrentCard();
        if (currentCard) {
            const frontContent = currentCard.querySelector('.card-front .card-content');
            return frontContent ? frontContent.textContent.trim() : '';
        }
        return '';
    }

    // åˆå§‹æ˜¾ç¤ºç¬¬ä¸€å¼ å¡ç‰‡
    showOnlyIndex(0);

    // æ’­æ”¾å½“å‰å¡ç‰‡å†…å®¹
    playButton.addEventListener('click', () => {
        const content = getCurrentCardContent();
        if (content && 'speechSynthesis' in window) {
            speechSynthesis.cancel(); // åœæ­¢ä¹‹å‰çš„æ’­æ”¾

            const currentCard = getCurrentCard();
            if (currentCard) {
                currentCard.classList.add('listening');
                listenStatus.textContent = 'æ­£åœ¨æ’­æ”¾...';
            }

            const utterance = new SpeechSynthesisUtterance(content);
            utterance.lang = 'zh-CN'; // è®¾ç½®ä¸­æ–‡è¯­éŸ³
            utterance.rate = 0.8; // ç¨æ…¢çš„è¯­é€Ÿ

            utterance.onend = () => {
                if (currentCard) {
                    currentCard.classList.remove('listening');
                }
                isRevealed = false;
            };

            speechSynthesis.speak(utterance);
        } else if (!content) {
            alert('æ²¡æœ‰æ‰¾åˆ°å¡ç‰‡å†…å®¹');
        } else {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
        }
    });

    // æ˜¾ç¤º/éšè—ç­”æ¡ˆ
    revealButton.addEventListener('click', () => {
        const currentCard = getCurrentCard();
        if (currentCard) {
            if (!isRevealed) {
                currentCard.classList.remove('listening');
                currentCard.classList.add('flipped');
                revealButton.textContent = 'ğŸ™ˆ éšè—ç­”æ¡ˆ';
                isRevealed = true;
            } else {
                currentCard.classList.remove('flipped');
                revealButton.textContent = 'ğŸ‘ï¸ æ˜¾ç¤ºç­”æ¡ˆ';
                isRevealed = false;
            }
        }
    });

    // ä¸‹ä¸€å¼ å¡ç‰‡
    nextButton.addEventListener('click', () => {
        showOnlyIndex(currentCardIndex + 1);
    });

    // é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'p' || e.key === 'P') {
            e.preventDefault();
            playButton.click();
        } else if (e.key === 'r' || e.key === 'R') {
            e.preventDefault();
            revealButton.click();
        } else if (e.key === 'ArrowRight') { // æ·»åŠ å³ç®­å¤´åˆ‡æ¢ä¸‹ä¸€å¼ å¡ç‰‡
            e.preventDefault();
            nextButton.click();
        } else if (e.key === 'ArrowLeft') { // æ·»åŠ å·¦ç®­å¤´åˆ‡æ¢ä¸Šä¸€å¼ å¡ç‰‡
            e.preventDefault();
            showOnlyIndex(currentCardIndex - 1);
        }
    });

    // åœæ­¢è¯­éŸ³æ’­æ”¾å½“é¡µé¢å¤±å»ç„¦ç‚¹æ—¶
    window.addEventListener('blur', () => {
        speechSynthesis.cancel();
        const currentCard = getCurrentCard();
        if (currentCard) {
            currentCard.classList.remove('listening');
        }
    });
</script>
{% endblock %}
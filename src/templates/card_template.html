{% extends "minimal.html" %}

{% block title %}{{ title }}{% endblock %}

{% block page_styles %}
<style>
    @media print {
        body {
            padding: 0;
            background-color: #fff; /* 打印时确保背景为白色 */
        }
        .card {
            width: 74.25mm; /* A7 尺寸 */
            height: 105mm;
            page-break-inside: avoid;
            break-inside: avoid;
            box-shadow: none;
            border: 1px solid #000;
        }
        .card-inner {
            transform: none !important;
            box-shadow: none;
        }
        .card-front, .card-back {
            position: relative;
            width: 100%;
            height: 100%;
            border: none; /* 移除内部边框，因为卡片本身已有边框 */
        }
        .card-back {
            border: 2px solid #000; /* 打印时反面边框加粗以作区分 */
        }
        .card-controls, header, .card-index, .deck-name {
            display: none !important; /* 打印时隐藏所有非卡片内容 */
        }
        main {
            padding: 0;
        }
        .flashcard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 每行2张卡片 */
            gap: 0;
            page-break-after: always;
        }
    }
</style>
{% endblock %}

{% block body_content %}
<div class="container">
    <header>
        <h1>{{ title }}</h1>
        {{ description_section | safe }}
    </header>

    <main>
        <!-- 闪卡网格 -->
        <div class="flashcard-grid" id="cardGrid">
            {{ cards_html | safe }}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.card');
        let currentCardIndex = 0;
        let visibleCards = Array.from(cards);

        function showCurrentCard() {
            if (visibleCards.length === 0) return;
            
            // 隐藏所有卡片
            cards.forEach(card => {
                card.style.display = 'none';
                card.classList.remove('active');
            });

            // 显示当前卡片
            const cardToShow = visibleCards[currentCardIndex];
            cardToShow.style.display = 'block';
            cardToShow.classList.add('active');
            updateCardIndexDisplay(cardToShow);
        }

        function updateCardIndexDisplay(card) {
            const cardIndexElement = card.querySelector('.card-index');
            if (cardIndexElement) {
                const overallIndex = Array.from(cards).indexOf(card);
                cardIndexElement.textContent = `${overallIndex + 1}/${cards.length}`;
            }
        }

        // 初始化所有卡片的序号
        cards.forEach((card, i) => {
            const indexText = `${i + 1}/${cards.length}`;
            ['.card-front', '.card-back'].forEach(selector => {
                const face = card.querySelector(selector);
                if (face) {
                    let span = face.querySelector('.card-index');
                    if (!span) {
                        span = document.createElement('div');
                        span.className = 'card-index';
                        face.appendChild(span);
                    }
                    span.textContent = indexText;
                }
            });
        });

        // 点击翻转
        cards.forEach(card => {
            card.addEventListener('click', function(e) {
                // 防止点击链接时翻转卡片
                if (e.target.tagName.toLowerCase() !== 'a') {
                    this.classList.toggle('flipped');
                }
            });
        });

        // 键盘导航
        document.addEventListener('keydown', function(e) {
            if (visibleCards.length === 0) return;

            if (e.key === 'ArrowLeft') {
                currentCardIndex = (currentCardIndex - 1 + visibleCards.length) % visibleCards.length;
                showCurrentCard();
            } else if (e.key === 'ArrowRight') {
                currentCardIndex = (currentCardIndex + 1) % visibleCards.length;
                showCurrentCard();
            } else if (e.key === ' ') {
                e.preventDefault();
                const activeCard = visibleCards[currentCardIndex];
                if (activeCard) {
                    activeCard.classList.toggle('flipped');
                }
            }
        });

        // 搜索功能已移除

        // 初始显示所有卡片
        cards.forEach(card => {
            card.style.display = 'block';
        });
    });
</script>
{% endblock %}
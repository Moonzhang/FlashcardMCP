# FastAPI 闪卡生成与模板说明

本文档梳理当前闪卡的样式与内容生成机制，详细描述生成顺序、主要生成组件、模板作用范围、内容生成步骤及控制方式，并提供接口与预览入口、示例请求与扩展建议。

---

## 概述

- 项目通过 FastAPI 服务接收 JSON 并生成完整的闪卡 HTML 页面。
- 核心流程包含：数据校验与规范化、Markdown 解析、模板渲染（结构、样式与交互）、输出页面。
- 模板负责页面结构与交互；内容转换在解析阶段完成；样式通过模板 CSS 控制。

---

## 生成顺序

1. 请求入口
   - `POST /convert_to_flashcards` 接收 JSON 请求，调用 `generate_flashcards`。
   - 预览入口：`GET /preview` 使用示例数据走同样流程，便于快速检查。
2. 校验与规范化
   - `validate_json_structure` 校验必填结构与字段类型，返回统一的验证结果；若无效抛错。
   - `normalize_json_data` 填充默认值（`metadata`, `style`, `cards`），兼容顶层 `title/description` 回退。
3. 内容解析
   - 为每张卡的 `front` 与 `back` 调用 `MarkdownParser.parse`，将 Markdown 转为 HTML。
   - 默认扩展支持：围栏代码（`fenced_code`）、表格（`tables`）、提示框（`admonition`）；可选 `toc` 目录与 `codehilite` 高亮。
4. 模板渲染
   - `render_flashcard_template` 依据 `style.template` 选择模板文件（优先配置路径，其次 `src/templates/<template>.html`，再回退内联模板）。
   - 合并主题、颜色与字体，将解析好的卡片 HTML 注入页面结构，生成最终 HTML。
5. 输出页面
   - 返回整页 HTML（含 CSS 与交互脚本），在浏览器中完成渲染与交互。

---

## 主要生成组件

- `src/handlers/card_generator.py`
  - `generate_flashcards(json_data)`: 总控流程，组织数据、解析 Markdown、调用模板渲染，返回整页 HTML。
  - `render_flashcard_template(...)`: 选择与加载模板、合并样式配置、组装卡片与页面结构。
- `src/utils/json_validator.py`
  - `validate_json_structure(data)`: 校验 JSON 结构与必填字段，返回 `is_valid/error`。
  - `normalize_json_data(data)`: 规范化 JSON，填充默认值，保证下游生成稳定。
- `src/utils/markdown_parser.py`
  - `MarkdownParser.parse(text)`: Markdown→HTML 转换；支持代码、表格、提示框、列表、图片、链接等。
  - 可定义自定义解析器（`create_custom_parser`），扩展 `toc` / `codehilite` 等。
- 模板：`src/templates/minimal.html` 及其他模板文件
  - 定义页面骨架（容器、网格、卡片正反面结构）、样式（主题、列表、表格等）与交互脚本（翻转与导航）。

---

## 模板作用范围

- 页面级结构：`<head>` 中的 CSS 变量与全局样式，`<body>` 中的容器与卡片网格。
- 卡片骨架：`.card`（卡片外层）、`.card-inner`（翻转容器）、`.card-front` 与 `.card-back`（正反面）。
- 主题与字体：通过模板中的 CSS 变量与 `font-family` 应用到整页。
- 交互脚本：模板内 `<script>` 提供卡片翻转、键盘导航与触控交互（具体以模板脚本为准）。

---

## 内容生成与控制

- 生成位置与时机
  - Markdown→HTML：在 `generate_flashcards` 中完成，对每张卡的正反面内容分别解析；列表、表格、代码、图片、标题等 HTML 在此阶段落地。
  - 页面拼装：在 `render_flashcard_template` 将解析后的 HTML 注入模板中的正反面占位，输出完整页面。
- 控制入口（JSON 字段）
  - `metadata.title` / `metadata.description`：闪卡集名称与描述（标题用于页面展示与正面标识）。
  - `style.template`：模板选择（如 `minimal` 对应 `src/templates/minimal.html`，未找到则回退内联）。
  - `style.theme` / `style.colors` / `style.font`：主题、配色（primary/secondary 等）、字体族。
  - `cards[].front/back/tags`：每张卡的正反面内容与标签；标签在模板中渲染为 `span.card-tag`。
- Markdown 行为
  - 列表：`-`（`<ul>`）与 `1.`（`<ol>`）；模板强制显示项目符号与序号，并设置外部定位与缩进。
  - 表格：标准表格语法生成 `<table>`；模板提供边框与单元格样式保障可读性。
  - 代码块：围栏代码生成 `<pre><code>`；可按需开启 `codehilite` 高亮。
  - 图片与链接：标准语法生成 `<img>` 与 `<a>`；图片属性会进行轻度重排以更稳健。

---

## 样式与布局（当前状态）

- 卡片结构与翻转
  - `.card` 固定尺寸与阴影，`.card-inner` 通过 `transform: rotateY(180deg)` 翻转，`.flipped` 类切换。
- 正面与反面布局
  - 正面：`deck-name` 已移动到 `.card-front` 内部，仅在正面显示；内容居中。
  - 反面：内容上下居中并左对齐，增加顶部内边距以提升可读性。
- 列表样式
  - `ul` 使用 `disc`，`ol` 使用 `decimal`；统一设置 `list-style-position: outside` 与左侧缩进；`li` 有适度垂直间距。
- 表格样式
  - 边框与内外边距、表头加粗等已配置，确保表格的结构化与可读性。
- 标签样式
  - `.card-tag` 以圆角、浅色背景与小字号呈现。

---

## 交互逻辑

- 点击卡片切换 `.flipped` 状态以翻转。
- 键盘导航与触屏交互（左右切换、滑动）由模板脚本提供。
- 具体交互以 `src/templates/minimal.html` 中的脚本为准。

---

## 可配置项与扩展

- 模板选择
  - 通过 `FLASHCARD_CONFIG.available_templates` 声明模板与 `file_path`；无配置时按名称在 `src/templates` 寻找并回退到内联模板。
- 解析扩展
  - 使用 `MarkdownParser` 的扩展列表启用 `toc`（目录）与 `codehilite`（代码高亮）等。
- 主题与样式扩展
  - 在模板 CSS 中扩展变量或样式块以适配更多配色与暗色模式。

---

## 关键文件与位置

- `src/handlers/card_generator.py`：生成主流程与模板渲染。
- `src/utils/json_validator.py`：结构校验与默认值填充。
- `src/utils/markdown_parser.py`：Markdown 解析与后处理。
- `src/templates/minimal.html`：当前主模板（结构、样式与交互）。
- `src/main.py`：路由入口（`/convert_to_flashcards`, `/preview`, `/`）。
- `tests/*`：完整的单元测试覆盖（生成、解析、结构、主题、渲染等）。

---

## 接口与预览

- 首页：`GET /`
- 预览：`GET /preview`
- 生成：`POST /convert_to_flashcards`

示例请求（cURL）：

```bash
curl -X POST -H "Content-Type: application/json" \
  -d '{
    "metadata": {"title": "预览闪卡集", "description": "示例数据生成的闪卡页面"},
    "style": {"template": "minimal", "theme": "light"},
    "cards": [
      {"front": "问题", "back": "答案", "tags": ["示例"]}
    ]
  }' \
  http://localhost:5000/convert_to_flashcards
```

---

## 示例 JSON（最小有效）

```json
{
  "metadata": {
    "title": "示例闪卡集",
    "description": "最小化数据演示"
  },
  "style": {
    "template": "minimal",
    "theme": "light",
    "colors": {},
    "font": "Arial, sans-serif"
  },
  "cards": [
    {
      "front": "# 标题\n\n- 项目 1\n- 项目 2",
      "back": "1. 第一项\n2. 第二项\n\n| 名称 | 描述 |\n|---|---|\n| Python | 高级编程语言 |",
      "tags": ["demo"]
    }
  ]
}
```

---

## 更新记录（近期关键变更）

- `deck-name` 元素移动到 `.card-front` 内部，确保仅在正面显示，移除翻转隐藏的样式冲突。
- 卡片反面优化为上下居中并左对齐，增加顶部内边距。
- 列表样式修复：为 `ul`/`ol` 明确设置项目符号与序号、外部定位与统一缩进；`li` 增加垂直间距。
- 表格样式补充：添加边框、间距与表头样式，提升可读性。

---

## 维护与扩展建议

- 模板管理：在 `config.FLASHCARD_CONFIG.available_templates` 中声明并维护模板列表与路径，统一入口。
- 解析策略：如需目录或代码高亮，使用 `create_custom_parser` 定制解析扩展与配置。
- 样式一致性：跨模板对 `.card`、`.card-inner`、`.card-front/.card-back` 保持一致的结构与变量；避免局部样式破坏交互。
- 测试覆盖：新增或调整模板/解析逻辑时，同步完善 `tests/test_card_generator.py` 与相关解析测试。

---

## 参考路径

- 路由与入口：`src/main.py`
- 生成器：`src/handlers/card_generator.py`
- 校验与规范化：`src/utils/json_validator.py`
- 解析器：`src/utils/markdown_parser.py`
- 模板：`src/templates/minimal.html`
- 测试：`tests/test_card_generator.py`, `tests/test_markdown_parser.py`, `tests/test_json_validator.py`